<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Prec</title>
    <script src="http://fb.me/react-0.11.1.js"></script>
    <script src="http://fb.me/JSXTransformer-0.11.1.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <h2>Everyday Account</h2>

    <div id="txns">
    </div>

    <h5>Upload a statement</h5>
    <form action="http://localhost:4000/txns" method="POST" enctype="multipart/form-data">
      <fieldset>
        <input type="file" name="txn_file" />
        <input type="submit" />
      </fieldset>
    </form>

    <script type="text/javascript">
      $(document).on('submit', 'form', function(event) {
        console.log(event);
        event.preventDefault();
        console.log($(this).serialize());
        console.log(new FormData($(this)[0]));
        $.ajax({
          url: $(this).attr('action'),
          type: $(this).attr('method'),
          contentType: 'multipart/form-data',
          dataType: 'json',
          data: $(this).serialize(),
          success: function(data) {
            console.log('AJAX form submitted.');
          },
          error: function(xhr, err) {
            console.log(err);
          }
        });
        return false;
      });
    </script>

    <script type="text/jsx">
      /** @jsx React.DOM */

      var TxnTable = React.createClass({
        getInitialState: function() {
          return { txns: [] };
        },

        getDefaultProps: function() {
          return {
            txnsURL: 'http://localhost:4000/txns',
            pollFrequency: 10000
          };
        },

        componentDidMount: function() {
          this.refreshTxns();
          setInterval(this.refreshTxns, this.props.pollFrequency);
        },

        refreshTxns: function() {
          $.getJSON(this.props.txnsURL, function(data) {
            this.setState({ txns: data });
          }.bind(this));
        },

        render: function() {
          var txns = this.state.txns;
          return (
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Debit</th>
                  <th>Credit</th>
                  <th>Balance</th>
                </tr>
              </thead>
              <tbody>
                {txns.map(function(txn) {
                  return <Txn txn={txn} />;
                })}
              </tbody>
            </table>
          );
        }
      });

      var Txn = React.createClass({
        render: function() {
          var txn = this.props.txn;
          return (
            <tr>
              <td>{txn.date}</td>
              <td>{txn.description}</td>
              <td>{txn.debitCents}</td>
              <td>{txn.creditCents}</td>
              <td>{txn.balanceCents}</td>
            </tr>
          );
        }
      });

      setInterval(function() {
        React.renderComponent(
          <TxnTable />,
          document.getElementById('txns')
        );
      }, 1000);
    </script>
  </body>
</html>
